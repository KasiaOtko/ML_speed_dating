---
title: "SD_dataset"
author: |
    | Katarzyna Otko s202872
    | Alvils Sture s202586
date: "October 2020"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r, message=F, warning=F}
library(dplyr)
library(ggplot2)
library(reshape2)
library(knitr)
library(tidyr)
library(mltools)
library(data.table)
setwd('C:/Users/katin/Desktop/Folder/STUDIA/DTU/Semestr I/Intro to ML/Project I')
SD <- read.csv('Speed Dating Data.csv')

# numdim(SDber of rows and columns
dim(SD)

# number of women
length(unique(SD$iid[which(SD$gender == 0)])) # 274

# number of men
length(unique(SD$iid[which(SD$gender == 1)])) # 277

274 + 277
```


## Missing values
```{r}
NAs <- sapply(SD, function(x) sum(is.na(x)))
sort(NAs[which(NAs > 0)])

#filling one missing value in last id row
SD[which(is.na(SD$id)), 1:2] <- 22

# filling 10 missing values in pid columns
SD[which(is.na(SD$pid)), 1:15] # partner's id - 7
SD[which(SD$id == 7 & SD$wave == 5), 1:2] # we have to fill these 10 NAs with 128
SD[which(is.na(SD$pid)), 'pid'] <- 128

# filling missing values in columns <attribute_name>1_1
DF <- SD[, 70:75]
df <- DF[!complete.cases(DF),]
dim(df); sum(rowSums(df, na.rm = T) == 100) # so there are 42 rows where we can impute 0s
df[which(df[,1] + df[,2] + df[,3] == 100),]
df[which(df[,1] + df[,2] + df[,3] == 100), c(4:6)] <- 0

df[which(df[,1] + df[,2] + df[,3] + df[,4] == 100),]
df[which(df[,1] + df[,2] + df[,3] + df[,4] == 100), c(5:6)] <- 0

df[which(df[,1] + df[,2] + df[,3] + df[,4] +df[, 5] == 100),]
df[which(df[,1] + df[,2] + df[,3] + df[,4] +df[, 5] == 100), 6] <- 0

DF[!complete.cases(DF),] <- df
SD[,70:75] <- DF

# adding one column with explanation for race column (matching index with race names)
race_idx <- unique(SD$race)
race_val <- c('Asian', 'European', 'Other', 'Latino', 'Black', NA)
SD$race_explained <- race_val[match(SD$race, race_idx)]

# adding one column with explanation for field_cd column (matching index with race names)
# DISCUSS WITH ALVILS IMPUTING DATA INTO field_cd as 9 (because field is Operations Research)
field_idx <- c(1:18, NA)
field_val <- c('Law', 'Math', 'Social Science, Psychologist', 'Medical Science/Pharmaceuticals/Bio Tech',
               'Engineering', 'English/Creative Writing/ Journalism', 'History/Religion/Philosophy',
              'Business/Econ/Finance', 'Education, Academia', 'Biological Sciences/Chemistry/Physics', 
              'Social Work', 'Undergrad/undecided', 'Political Science/International Affairs',
              'Film', 'Fine Arts/Arts Administration', 'Languages', 'Architecture', 'Other', 'Other')
SD$field_explained <- field_val[match(SD$field_cd, field_idx)]

# converting income from string to numeric
SD$income <- as.numeric(gsub(',', "", SD$income, fixed = T))
```


## Normalizing values for waves 6 - 9
```{r}
# Waves 6 - 9:
# attr4_1 - shar4_1 have values between 0 and 10
# attr2_1 - shar2_1 OK
# attr1_2 - shar1_2 OK
which(colnames(SD) == 'attr1_1')
summary(SD[SD$wave >= 6 & SD$wave <= 9,70:76]) # each feature is between 1-10, while they all should add up to 100
df <- SD[SD$wave >= 6 & SD$wave <= 9,76:81]
df_norm <- df

for(col in 1:ncol(df)) {
  df_norm[[colnames(df)[col]]] <- df[[colnames(df)[col]]]/rowSums(df, na.rm = T)*100
}

unique(rowSums(df_norm, na.rm = T))
SD[SD$wave >= 6 & SD$wave <= 9,76:81] <- df_norm
head(SD[SD$wave >= 6 & SD$wave <= 9,76:81])
```

```{r}
# Importance of each attribute by gender
attr <- subset(SD, !duplicated(SD$iid), select = c(3, 70:75)) %>%
  filter(!is.na(attr1_1))  %>% # 7 people with missing values
  group_by(gender) %>%
  summarize(Attractiveness = mean(attr1_1),
            Sincerity = mean(sinc1_1),
            Intelligence = mean(intel1_1),
            Fun = mean(fun1_1, na.rm = T),
            Ambition = mean(amb1_1, na.rm = T),
            'Shared interests' = mean(shar1_1, na.rm = T))

data_long <- pivot_longer(attr, !gender) # manipulating data to  plot

data_long %>% ggplot(aes(x = name, y = value, fill = factor(gender))) + 
  geom_bar(stat = 'identity', position = 'dodge', width = 0.8) +
  xlab('Attribute') + ylab('Average importance') + ggtitle('Average importance of each attribute by gender') +
  geom_text(aes(label = ifelse((fmt <- format(round(value,1), nsmall=1)) == "0.0", "d", as.character(fmt))), 
            position=position_dodge(width = 0.9), vjust = -0.5, size = 3.2) +
  scale_fill_discrete(name="Gender",
                         breaks=c(0, 1),
                         labels=c("Women", "Men")) + # Editing legend
  theme_minimal() + # Changing theme
  theme(plot.title = element_text(hjust = 0.5), # Centers title
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 12), # x/y labels position
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 12)) 
```

```{r}
# Age analysis
sum(is.na(SD$age))
SD[is.na(SD$age), 1:10]

age_df <- subset(SD, !duplicated(SD[,1])) %>%
  filter(!is.na(age)) %>%
  group_by(wave, gender) %>%
  summarize(Average_age = mean(age))

SD %>% nrow()
nrow(SD)

age_df$gender <- ifelse(age_df$gender == 0, 'Women', 'Men')

# Mean age per wave
age_df %>% ggplot(aes(x = wave, y = Average_age, fill = gender)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  scale_fill_discrete(name = "Gender") 

age_df <- subset(SD, !duplicated(SD$iid), select = c(iid, gender, age)) %>%
  filter(!is.na(age)) %>%
  mutate(mean = mean(age))
age_df$gender <- ifelse(age_df$gender == 0, 'Women', 'Men')

# Histogram of age
max(unique(age_df$age)) - min(unique(age_df$age)) # number of bins
age_df %>% ggplot(aes(x = age)) + 
  geom_histogram(bins = 37, fill = 'lightgrey', position = 'identity', alpha = .7) +
  geom_vline(aes(xintercept = mean), col = 'red', linetype = 'dashed')
```

```{r}
# Field analysis
field_df <- subset(SD, !duplicated(SD$iid)) %>%
  filter(!is.na(field_cd)) %>%
  group_by(field_explained) %>%
  summarize(field_sum = n())

#field_df$gender <- ifelse(field_df$gender == 0, 'Women', 'Men')

field_plot <- field_df %>% ggplot(aes(x = field_explained, y = field_sum)) + 
  geom_bar(stat = 'identity', position = 'dodge') + 
  xlab('Count') + ylab('Field of study') + ggtitle('Overwiev of participants\' study fields') +
  coord_flip() +
  theme_minimal() + # Changing theme
  theme(plot.title = element_text(hjust = 0.5), # Centers title
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 12), # x/y labels position
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0), size = 12))

race_df <- subset(SD, !duplicated(SD$iid)) %>%
  filter(!is.na(race_explained)) %>%
  group_by(race_explained) %>%
  summarize(race_sum = n())
race_df <- rbind(race_df, c('Native American', 0))

race_plot <- race_df %>% ggplot(aes(x = race_explained, y = race_sum)) + 
  geom_bar(stat = 'identity', position = 'dodge') +
  scale_x_discrete()
race_plot

```

```{r}
# Income
income_df <- subset(SD, !duplicated(SD$iid)) %>%
  filter(!is.na(income))

income_df$gender <- ifelse(income_df$gender == 0, 'Women', 'Men')

income_df %>% ggplot(aes(x = income/1000, fill = gender)) + 
  geom_histogram(bins = 15)

```

```{r}
# Purpose
goal_df <- subset(SD, !duplicated(SD$iid)) %>%
  filter(!is.na(goal)) %>%
  group_by(goal, gender) %>%
  summarise(count = n())

goal_df$gender <- ifelse(goal_df$gender == 0, 'Women', 'Men')

goal_idx <- unique(goal_df$goal)
goal_val <- c('Seemed like a fun night out', 'To meet new people', 'To get a date', 
              'Looking for a serious relationship', 'To say I did it',	'Other')
goal_df$goal_explained <- goal_val[match(goal_df$goal, goal_idx)]

goal_df %>% ggplot(aes(x = goal_explained, y = count, fill = gender)) + 
  geom_bar(stat = 'identity', position = 'dodge') +
  coord_flip()

```

```{r}

SD[(SD$dec == 1), c('iid', 'id', 'gender', 'wave','dec', 'match', 'partner', 'pid')]
SD[SD$iid == 11 & SD$partner == 1, c('iid', 'id', 'gender', 'wave','dec', 'match', 'partner', 'pid')]


df <- SD[SD$wave == 1,]
unique(df$id)
length(unique(SD$iid[which(SD$gender == 0)]))
df
```

## PCA

```{r}
colnames(SD)[51:67]
which(colnames(SD) == 'attr1_1')
data.table()

race_idx <- unique(SD$race)
race_val <- c('Asian', 'European', 'Other', 'Latino', 'Black', NA)
SD$race_explained <- race_val[match(SD$race, race_idx)]

Y <- subset(SD, !duplicated(SD$iid), select = c(3, 196, 34, 41, 42, 70:72, 88, 91, 92, 82:84))

asian <- ifelse(Y$race_explained == 'Asian', 1, 0)
european <- ifelse(Y$race_explained == 'European', 1, 0)
other <- ifelse(Y$race_explained == 'Other', 1, 0)
latino <- ifelse(Y$race_explained == 'Latino', 1, 0)
black <- ifelse(Y$race_explained == 'Black', 1, 0)

Y <- cbind(Y, asian, european, other, latino, black)

Y <- Y[,(-2)]
summary(Y)
Y <- t(apply(Y, 1, '-', colMeans(Y, na.rm = T)))

for (i in 1:ncol(Y)) {
  sds[i] <- sd(Y[,i], na.rm = T)
}
names(sds) <- colnames(Y)
for (i in 2:13) {
  Y[,i] <- Y[,i]/sds[i]
}

summary(Y)
colMeans(Y, na.rm = T)

s <- svd(Y[complete.cases(Y),])
diagS <- s$d
rho <- diagS^2/sum(diagS^2)

threshold = 0.9


xlimits <- c(1, ncol(Y)); 
plot(rho,
     type='o',
     main="Variance explained by principal components",
     xlab="Principal components", 
     ylab="Variance explained",
     xlim=xlimits,
     ylim=c(0,1),
     col='blue')
lines(cumsum(rho), type='o', col='orange')
lines(xlimits, c(threshold, threshold), lty='dashed')

legend("right", # Define position
       legend=c("Cumulative", "Individual", "Threshold"), # Set strings for legend
       col=c("orange", "blue", "black"), lty=c(1,1,2), # Match appereance of lines
       cex=1.5, bg='lightblue') # Setup how the box looks (cex controls size)

rownames(s$v) <- colnames(Y)



```
